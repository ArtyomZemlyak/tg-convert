# Асинхронная реализация Telegram бота

## Обзор изменений

Бот был полностью переписан для использования асинхронной архитектуры, что значительно улучшает производительность и позволяет обрабатывать множественные запросы одновременно.

## Основные изменения

### 1. Замена библиотеки
- **Было**: `pyTelegramBotAPI` (синхронная)
- **Стало**: `aiogram` (асинхронная)

### 2. Асинхронные методы
Все основные методы бота теперь асинхронные:
- `start_command()` - обработка команды /start
- `help_command()` - обработка команды /help  
- `button_callback()` - обработка нажатий кнопок
- `handle_document()` - обработка загруженных файлов
- `_download_file()` - асинхронная загрузка файлов
- `_convert_video()` - асинхронная конвертация видео
- `_send_converted_video()` - асинхронная отправка результата
- `_cleanup_temp_files()` - асинхронная очистка временных файлов

### 3. Улучшения производительности

#### Асинхронная загрузка файлов
```python
async def _download_file(self, document, tmp_dir: Path) -> Path:
    async with aiohttp.ClientSession() as session:
        async with session.get(file_url) as response:
            async with aiofiles.open(file_path, 'wb') as f:
                async for chunk in response.content.iter_chunked(8192):
                    await f.write(chunk)
```

#### Асинхронная конвертация видео
```python
async def _convert_video(self, input_path: Path, tmp_dir: Path) -> Path:
    process = await asyncio.create_subprocess_exec(
        *docker_cmd,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE
    )
    stdout, stderr = await asyncio.wait_for(
        process.communicate(), 
        timeout=CONVERSION_TIMEOUT
    )
```

### 4. Управление ресурсами

#### Семафор для ограничения одновременных конвертаций
```python
self.conversion_semaphore = asyncio.Semaphore(3)  # Максимум 3 одновременные конвертации

async with self.conversion_semaphore:
    # Выполнение конвертации
```

#### Отслеживание активных конвертаций
```python
self.active_conversions = {}  # Предотвращение дублирования запросов

if user_id in self.active_conversions:
    await message.answer("⏳ У вас уже идет конвертация видео...")
    return
```

### 5. FSM (Finite State Machine)
Добавлена поддержка состояний для лучшего управления диалогом:
```python
class VideoStates(StatesGroup):
    waiting_for_video = State()
```

## Преимущества асинхронной реализации

### 1. Производительность
- **Параллельная обработка**: Множественные запросы обрабатываются одновременно
- **Неблокирующие операции**: I/O операции не блокируют основной поток
- **Эффективное использование ресурсов**: Лучшее использование CPU и памяти

### 2. Масштабируемость
- **Ограничение нагрузки**: Семафор ограничивает количество одновременных конвертаций
- **Очередь задач**: Возможность добавления системы очередей для больших нагрузок
- **Мониторинг**: Отслеживание активных операций

### 3. Надежность
- **Таймауты**: Контроль времени выполнения операций
- **Обработка ошибок**: Улучшенная обработка исключений
- **Очистка ресурсов**: Автоматическая очистка временных файлов

## Тестирование

Созданы тесты для проверки асинхронной функциональности:

### test_async_bot.py
- Тест асинхронной загрузки файлов
- Тест параллельных операций
- Тест ограничений семафором

### test_bot_import.py
- Проверка корректности импорта
- Валидация асинхронных методов

## Запуск

```bash
# Установка зависимостей
pip3 install -r requirements.txt

# Запуск бота
python3 telegram_bot.py
```

## Требования

- Python 3.8+
- Docker (для конвертации видео)
- NVIDIA GPU (для аппаратного ускорения)

## Конфигурация

Переменные окружения:
- `TELEGRAM_BOT_TOKEN` - токен бота
- `CONVERSION_TIMEOUT` - таймаут конвертации (по умолчанию 300 секунд)

## Мониторинг

Бот ведет подробные логи:
- `logs/bot.log` - общие логи
- `logs/error.log` - логи ошибок

## Дополнительные возможности

### async_improvements.py
Содержит дополнительные утилиты для асинхронной работы:
- Очередь конвертаций
- Отмена задач
- Пакетная обработка файлов
- Управление ресурсами

## Заключение

Асинхронная реализация значительно улучшает производительность бота, позволяя:
- Обрабатывать множественные запросы одновременно
- Эффективно использовать системные ресурсы
- Масштабироваться под высокие нагрузки
- Обеспечивать лучший пользовательский опыт

Все функции бота сохранены, но теперь работают асинхронно для максимальной эффективности.